# Phase 1 — Tasks 8–11: App Layout & 3D Hall Scene

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build the visual shell — desktop sidebar + R3F canvas with the BORGA hall rendered top-down (floor, walls, doors, windows, grid, camera).

**Prereqs:** Task 7 complete (store, types, constants all working).

---

### Task 8: Build App Layout Shell

**Files:**
- Create: `src/components/ui/Sidebar.tsx`
- Create: `src/components/ui/Toolbar.tsx`
- Modify: `src/App.tsx`

**Step 1: Create Toolbar component**

Create `src/components/ui/Toolbar.tsx`:

```tsx
import { useStore } from "../../store";
import type { Tool } from "../../types";

const tools: { tool: Tool; label: string; icon: string }[] = [
  { tool: "select", label: "Select", icon: "↖" },
  { tool: "place", label: "Place", icon: "+" },
  { tool: "delete", label: "Delete", icon: "✕" },
];

export function Toolbar() {
  const activeTool = useStore((s) => s.ui.tool);
  const setTool = useStore((s) => s.setTool);

  return (
    <div className="flex items-center gap-1 border-b border-gray-200 bg-white px-3 py-2">
      {tools.map(({ tool, label, icon }) => (
        <button
          key={tool}
          onClick={() => setTool(tool)}
          className={`rounded px-3 py-1.5 text-sm font-medium transition-colors ${
            activeTool === tool
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-700 hover:bg-gray-200"
          }`}
        >
          <span className="mr-1">{icon}</span>
          {label}
        </button>
      ))}
    </div>
  );
}
```

**Step 2: Create Sidebar shell**

Create `src/components/ui/Sidebar.tsx`:

```tsx
import { useStore } from "../../store";
import type { SidebarTab } from "../../types";

const tabs: { tab: SidebarTab; label: string }[] = [
  { tab: "holes", label: "Holes" },
  { tab: "detail", label: "Detail" },
  { tab: "budget", label: "Budget" },
];

export function Sidebar() {
  const activeTab = useStore((s) => s.ui.sidebarTab);
  const setSidebarTab = useStore((s) => s.setSidebarTab);

  return (
    <div className="flex h-full w-64 flex-col border-r border-gray-200 bg-white">
      <div className="flex border-b border-gray-200">
        {tabs.map(({ tab, label }) => (
          <button
            key={tab}
            onClick={() => setSidebarTab(tab)}
            className={`flex-1 px-2 py-2 text-xs font-medium transition-colors ${
              activeTab === tab
                ? "border-b-2 border-blue-600 text-blue-600"
                : "text-gray-500 hover:text-gray-700"
            }`}
          >
            {label}
          </button>
        ))}
      </div>
      <div className="flex-1 overflow-y-auto p-3">
        <p className="text-xs text-gray-400">
          {activeTab === "holes" && "Hole library — coming in Task 12"}
          {activeTab === "detail" && "Select a hole to see details"}
          {activeTab === "budget" && "Budget tracker — Phase 4"}
        </p>
      </div>
    </div>
  );
}
```

**Step 3: Wire up App layout with R3F Canvas**

Replace `src/App.tsx`:

```tsx
import { Canvas } from "@react-three/fiber";
import { Toolbar } from "./components/ui/Toolbar";
import { Sidebar } from "./components/ui/Sidebar";

export default function App() {
  return (
    <div className="flex h-screen w-screen flex-col overflow-hidden bg-gray-100">
      <Toolbar />
      <div className="flex flex-1 overflow-hidden">
        <Sidebar />
        <div className="flex-1">
          <Canvas
            orthographic
            camera={{ position: [0, 50, 0], zoom: 40, near: 0.1, far: 200 }}
            dpr={[1, 2]}
            frameloop="demand"
          >
            <ambientLight intensity={0.8} />
            <directionalLight position={[10, 20, 5]} intensity={0.5} />
            <gridHelper args={[20, 20, "#cccccc", "#eeeeee"]} />
          </Canvas>
        </div>
      </div>
    </div>
  );
}
```

**Step 4: Verify visually**

Run: `npm run dev`
Expected: Browser shows toolbar at top, sidebar on left with tabs, and a 3D canvas area with a grid. Verify toolbar buttons toggle active state, sidebar tabs switch.

**Step 5: Commit**

```bash
git add src/App.tsx src/components/ui/
git commit -m "feat: add app layout shell with toolbar, sidebar, and R3F canvas"
```

---

### Task 9: Render Hall Floor, Walls, Doors, Windows

**Files:**
- Create: `src/components/three/HallFloor.tsx`
- Create: `src/components/three/HallWalls.tsx`
- Create: `src/components/three/HallOpenings.tsx`
- Create: `src/components/three/Hall.tsx`
- Modify: `src/App.tsx`

**Step 1: Create floor component**

Create `src/components/three/HallFloor.tsx`:

```tsx
import { useStore } from "../../store";

export function HallFloor() {
  const { width, length } = useStore((s) => s.hall);

  return (
    <mesh rotation={[-Math.PI / 2, 0, 0]} position={[width / 2, 0, length / 2]}>
      <planeGeometry args={[width, length]} />
      <meshStandardMaterial color="#E0E0E0" />
    </mesh>
  );
}
```

**Step 2: Create walls component**

Create `src/components/three/HallWalls.tsx`:

```tsx
import { useStore } from "../../store";

export function HallWalls() {
  const { width, length, wallHeight, wallThickness } = useStore((s) => s.hall);
  const halfH = wallHeight / 2;
  const color = "#B0B0B0";

  return (
    <group>
      {/* North wall (z=0) */}
      <mesh position={[width / 2, halfH, 0]}>
        <boxGeometry args={[width, wallHeight, wallThickness]} />
        <meshStandardMaterial color={color} />
      </mesh>
      {/* South wall (z=length) */}
      <mesh position={[width / 2, halfH, length]}>
        <boxGeometry args={[width, wallHeight, wallThickness]} />
        <meshStandardMaterial color={color} />
      </mesh>
      {/* West wall (x=0) */}
      <mesh position={[0, halfH, length / 2]}>
        <boxGeometry args={[wallThickness, wallHeight, length]} />
        <meshStandardMaterial color={color} />
      </mesh>
      {/* East wall (x=width) */}
      <mesh position={[width, halfH, length / 2]}>
        <boxGeometry args={[wallThickness, wallHeight, length]} />
        <meshStandardMaterial color={color} />
      </mesh>
    </group>
  );
}
```

**Step 3: Create door/window overlays**

Create `src/components/three/HallOpenings.tsx`:

```tsx
import { useStore } from "../../store";
import type { DoorSpec, WindowSpec } from "../../types";

function getWallPosition(
  wall: string,
  offset: number,
  centerY: number,
  hallWidth: number,
  hallLength: number,
  itemWidth: number,
): [number, number, number] {
  const wallOffset = 0.02; // slight offset to prevent z-fighting
  switch (wall) {
    case "north":
      return [offset + itemWidth / 2, centerY, -wallOffset];
    case "south":
      return [offset + itemWidth / 2, centerY, hallLength + wallOffset];
    case "west":
      return [-wallOffset, centerY, offset + itemWidth / 2];
    case "east":
      return [hallWidth + wallOffset, centerY, offset + itemWidth / 2];
    default:
      return [0, 0, 0];
  }
}

function getWallRotation(wall: string): [number, number, number] {
  switch (wall) {
    case "north":
    case "south":
      return [0, 0, 0];
    case "west":
    case "east":
      return [0, Math.PI / 2, 0];
    default:
      return [0, 0, 0];
  }
}

function Door({ door, hallWidth, hallLength }: {
  door: DoorSpec;
  hallWidth: number;
  hallLength: number;
}) {
  const centerY = door.height / 2;
  const position = getWallPosition(
    door.wall, door.offset, centerY, hallWidth, hallLength, door.width,
  );
  const rotation = getWallRotation(door.wall);
  const color = door.type === "sectional" ? "#4CAF50" : "#81C784";

  return (
    <mesh position={position} rotation={rotation}>
      <planeGeometry args={[door.width, door.height]} />
      <meshStandardMaterial color={color} side={2} />
    </mesh>
  );
}

function Window({ window: win, hallWidth, hallLength }: {
  window: WindowSpec;
  hallWidth: number;
  hallLength: number;
}) {
  const centerY = win.sillHeight + win.height / 2;
  const position = getWallPosition(
    win.wall, win.offset, centerY, hallWidth, hallLength, win.width,
  );
  const rotation = getWallRotation(win.wall);

  return (
    <mesh position={position} rotation={rotation}>
      <planeGeometry args={[win.width, win.height]} />
      <meshStandardMaterial color="#64B5F6" side={2} />
    </mesh>
  );
}

export function HallOpenings() {
  const { doors, windows, width, length } = useStore((s) => s.hall);

  return (
    <group>
      {doors.map((door) => (
        <Door key={door.id} door={door} hallWidth={width} hallLength={length} />
      ))}
      {windows.map((win) => (
        <Window key={win.id} window={win} hallWidth={width} hallLength={length} />
      ))}
    </group>
  );
}
```

**Step 4: Create Hall container component**

Create `src/components/three/Hall.tsx`:

```tsx
import { HallFloor } from "./HallFloor";
import { HallWalls } from "./HallWalls";
import { HallOpenings } from "./HallOpenings";

export function Hall() {
  return (
    <group>
      <HallFloor />
      <HallWalls />
      <HallOpenings />
    </group>
  );
}
```

**Step 5: Add Hall to App canvas**

In `src/App.tsx`, import and add `<Hall />` inside the `<Canvas>`:

```tsx
import { Hall } from "./components/three/Hall";
```

Replace the `<Canvas>` contents:

```tsx
<Canvas
  orthographic
  camera={{ position: [0, 50, 0], zoom: 40, near: 0.1, far: 200 }}
  dpr={[1, 2]}
  frameloop="demand"
>
  <ambientLight intensity={0.8} />
  <directionalLight position={[10, 20, 5]} intensity={0.5} />
  <Hall />
</Canvas>
```

**Step 6: Verify visually**

Run: `npm run dev`
Expected: Top-down view of a gray rectangle (10×20m floor) with gray walls around it. Green and blue rectangles on walls for doors/windows. The view should look like a floor plan from above.

**Step 7: Commit**

```bash
git add src/components/three/
git commit -m "feat: render BORGA hall floor, walls, doors, and windows in 3D"
```

---

### Task 10: Add Grid Overlay

**Files:**
- Create: `src/components/three/FloorGrid.tsx`
- Modify: `src/App.tsx`

**Step 1: Create grid component**

Create `src/components/three/FloorGrid.tsx`:

```tsx
import { Grid } from "@react-three/drei";
import { useStore } from "../../store";

export function FloorGrid() {
  const { width, length } = useStore((s) => s.hall);

  return (
    <Grid
      position={[width / 2, 0.01, length / 2]}
      args={[width, length]}
      cellSize={1}
      cellThickness={0.5}
      cellColor="#cccccc"
      sectionSize={5}
      sectionThickness={1}
      sectionColor="#999999"
      fadeDistance={50}
      infiniteGrid={false}
    />
  );
}
```

**Step 2: Add to Canvas in App.tsx**

Import and add `<FloorGrid />` inside the `<Canvas>`, after `<Hall />`.

**Step 3: Verify visually**

Run: `npm run dev`
Expected: 1m grid lines visible on the floor, with thicker lines every 5m.

**Step 4: Commit**

```bash
git add src/components/three/FloorGrid.tsx src/App.tsx
git commit -m "feat: add floor grid overlay with 1m/5m spacing"
```

---

### Task 11: Set Up Top-Down Camera with Pan/Zoom

**Files:**
- Create: `src/components/three/CameraControls.tsx`
- Modify: `src/App.tsx`

**Step 1: Create camera controls**

Create `src/components/three/CameraControls.tsx`:

```tsx
import { OrbitControls } from "@react-three/drei";
import { useStore } from "../../store";

export function CameraControls() {
  const { width, length } = useStore((s) => s.hall);

  return (
    <OrbitControls
      target={[width / 2, 0, length / 2]}
      enableRotate={false}
      enablePan={true}
      enableZoom={true}
      minZoom={15}
      maxZoom={120}
      mouseButtons={{
        LEFT: undefined,
        MIDDLE: 2, // PAN
        RIGHT: 2,  // PAN
      }}
      touches={{
        ONE: undefined,
        TWO: 512, // DOLLY_PAN
      }}
      makeDefault
    />
  );
}
```

Note: `LEFT` is `undefined` so left-click is free for selecting/placing holes. Pan is on middle/right click. Zoom via scroll wheel.

**Step 2: Update Canvas camera and add controls**

In `src/App.tsx`, update the Canvas to use centered camera and add `<CameraControls />`:

```tsx
import { CameraControls } from "./components/three/CameraControls";
```

Update camera position to center over the hall:

```tsx
<Canvas
  orthographic
  camera={{
    position: [5, 50, 10],
    zoom: 40,
    near: 0.1,
    far: 200,
  }}
  dpr={[1, 2]}
  frameloop="demand"
>
  <ambientLight intensity={0.8} />
  <directionalLight position={[10, 20, 5]} intensity={0.5} />
  <CameraControls />
  <FloorGrid />
  <Hall />
</Canvas>
```

**Step 3: Verify interactivity**

Run: `npm run dev`
Expected:
- Hall centered in view from top-down
- Scroll wheel zooms in/out
- Right-click + drag pans the view
- Middle-click + drag pans the view
- Left-click does nothing (reserved for tools)
- `frameloop="demand"` means canvas only re-renders when interactions happen (check: no CPU usage when idle)

**Step 4: Commit**

```bash
git add src/components/three/CameraControls.tsx src/App.tsx
git commit -m "feat: add top-down orthographic camera with pan/zoom controls"
```
